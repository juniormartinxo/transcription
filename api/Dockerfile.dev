# Dockerfile.dev - Development with Hot Reload
FROM python:3.12-slim

# Argumentos para UID/GID personalizáveis
ARG USER_ID=1000
ARG GROUP_ID=1000

# Instalar dependências do sistema
RUN apt-get update && apt-get install -y \
    ffmpeg \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Criar usuário não-root com UID/GID customizáveis
RUN groupadd -g ${GROUP_ID} appuser && \
    useradd -r -u ${USER_ID} -g appuser -d /home/appuser -m appuser

# Configurar diretório de trabalho
WORKDIR /app

# Criar diretórios necessários
RUN mkdir -p /app/src /app/public/audios /app/public/transcriptions /app/public/videos /app/logs /app/cache/huggingface /app/cache/torch

# Configurar diretórios home do usuário
RUN mkdir -p /home/appuser/.cache /home/appuser/.config

# Configurar permissões
RUN chown -R appuser:appuser /app /home/appuser
RUN chmod -R 755 /app /home/appuser

# Mudar para usuário não-root ANTES de instalar dependências Python
USER appuser

# Copiar e instalar dependências Python como usuário não-root
COPY api/requirements.txt .
RUN pip install --user --no-cache-dir -r requirements.txt

# Instalar uvicorn com hot reload para desenvolvimento
RUN pip install --user --no-cache-dir "uvicorn[standard]"

# Adicionar diretório do usuário ao PATH
ENV PATH="/home/appuser/.local/bin:${PATH}"

# Configurar variáveis de ambiente para desenvolvimento
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV DEVELOPMENT=true

# Expor porta
EXPOSE 8000

# Comando padrão com hot reload
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--reload", "--reload-dir", "src/", "--reload-dir", "./"]